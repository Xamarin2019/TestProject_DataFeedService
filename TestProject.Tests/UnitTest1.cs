using ConsoleAppNetMQ;
using Moq;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Xunit;
using Xunit.Abstractions;

namespace TestProject.Tests
{
    public class UnitTest1
    {
        private readonly ITestOutputHelper TestContext;

        public UnitTest1(ITestOutputHelper output) //, TextWriter outputWriter
        {
            TestContext = output;
            System.Diagnostics.Trace.Listeners.Add(new TestTraceListener(output));
            ConsoleAppNetMQ.Console.console = new Mock<IConsole>().Object;
        }

        [Fact]
        public void FileSystem_Test()
        {
            // Arrange
            TestContext.WriteLine($"FileSystem_Test");
            string zipPath = @"..\..\..\data.zip";

            // Act
            var fileSystem = new FileSystem(zipPath);
            var files = fileSystem.GetFileEntries();

            // Assert
            Assert.True(files.Length == 3);
        }

        [Fact]
        public async Task DataParser_Test()
        {
            // Arrange
            TestContext.WriteLine($"DataParser_Test");
            string path = @"..\..\..\data\AAPL.csv";

            // Act
            var dataParser = new DataParser();
            var tuple = await dataParser.ReceiveCsvData(path);

            // Assert
            Assert.True(tuple.Item1 == "AAPL");
            Assert.True(tuple.Item2.Length == 9999);
        }

        [Fact]
        public void Publisher_Test()
        {
            // Arrange
            TestContext.WriteLine($"Publisher_Test");
            string expected = "{\"Last\":\"2022-04-14 04:00:00.017611\",\"BasisForLast\":\"1\",\"TimeStamp\":null}";
            KeyValuePair<string, SortedDictionary<DateTime, List<MarketData>>> result = new KeyValuePair<string, SortedDictionary<DateTime, List<MarketData>>>();
            var fileSystemFake = new Mock<IFileSystem>() { CallBase = true };
            fileSystemFake.Setup(f => f.GetFileEntries()).Returns(new string[] { @"..\..\..\data\AAPL.csv" });
            var dataParserFake = new Mock<DataParser>() { CallBase = true };
            dataParserFake.Setup(p => p.ParseCsvData(It.IsAny<(string, string[])>())).Returns(((string, string[]) args) => result = new DataParser().ParseCsvData(args));

            // Act
            var publisher = new Publisher(dataParserFake.Object, fileSystemFake.Object);

            // Assert
            var actual = result.Value.Values.ToArray()[0][0].ToString();
            Assert.True(result.Key == "AAPL");
            Assert.True(actual == expected);
        }
    }
}










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































